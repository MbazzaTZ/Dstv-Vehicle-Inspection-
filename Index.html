<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSTV Tanzania - Vehicle Inspection System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary-color: #0033a0;
            --secondary-color: #f5f5f5;
            --border-color: #ccc;
            --text-color: #333;
            --ok-color: #4CAF50;
            --attention-color: #FF9800;
            --replace-color: #F44336;
            --progress-color: #4CAF50;
            --error-color: #f44336;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        /* Header Styles */
        .header-banner {
            background-color: var(--primary-color);
            width: 100%;
            padding: 15px 0;
            color: white;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .logo-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
        }

        .company-logo {
            height: 70px;
            width: auto;
        }

        .page-title {
            font-size: 24px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Login Styles */
        .login-container {
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            width: 100%;
            max-width: 400px;
            margin: 50px auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .login-container h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        .login-btn {
            background: var(--primary-color);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-btn:hover {
            background: #00257a;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 14px;
        }

        .logout-btn {
            background: var(--error-color);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        /* Form Container */
        .form-container {
            background: #fff;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 100%;
            max-width: 1000px;
            margin: 20px auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Regional Selection */
        .regional-selection {
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .selection-row {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .selection-group {
            flex: 1;
            min-width: 200px;
        }

        .selection-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .selection-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }

        /* Progress Bar */
        .progress-container {
            margin: 20px 0;
            background: #e0e0e0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--progress-color);
            width: 0%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .progress-text {
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }

        /* Insights Panel */
        .insights-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .insight-item {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .insight-count {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .insight-ok .insight-count {
            color: var(--ok-color);
        }

        .insight-attention .insight-count {
            color: var(--attention-color);
        }

        .insight-damage .insight-count {
            color: var(--replace-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        table, th, td {
            border: 1px solid #000;
        }

        th, td {
            padding: 8px;
            font-size: 14px;
        }

        th {
            background: #eaeaea;
            font-weight: bold;
            text-align: left;
        }

        .section-title {
            margin-top: 35px;
            font-weight: bold;
            font-size: 18px;
            text-transform: uppercase;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }

        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px auto;
            flex-wrap: wrap;
        }

        .action-btn {
            display: inline-block;
            width: 180px;
            background: var(--primary-color);
            color: white;
            padding: 12px;
            border: none;
            border-radius: 6px;
            text-align: center;
            text-decoration: none;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .action-btn:hover {
            background: #00257a;
        }

        .action-btn.secondary {
            background: #6c757d;
        }

        .action-btn.secondary:hover {
            background: #5a6268;
        }

        .action-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }

        @media print {
            .action-buttons, .signature-pad-container, .footer-nav, .regional-selection, .user-info {
                display: none;
            }
            body {
                background: white;
                margin: 0;
            }
            .form-container {
                box-shadow: none;
                border: 1px solid #000;
            }
            .signature-display {
                display: block !important;
                height: 80px;
                border-bottom: 1px solid #000;
                margin-top: 10px;
            }
        }

        @media (max-width: 768px) {
            .form-container {
                padding: 15px;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 5px;
            }
            
            .action-btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .signature-pad-container {
                height: 150px;
            }
            
            .insights-panel {
                grid-template-columns: 1fr;
            }
            
            .selection-row {
                flex-direction: column;
            }
            
            .user-info {
                position: static;
                margin: 10px;
                text-align: center;
            }
        }

        /* Status indicators */
        .status-ok {
            color: var(--ok-color);
            font-weight: bold;
        }
        
        .status-attention {
            color: var(--attention-color);
            font-weight: bold;
        }
        
        .status-replace {
            color: var(--replace-color);
            font-weight: bold;
        }
        
        /* Form fields styling */
        input[type="text"], input[type="date"], input[type="file"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }
        
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        
        textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            resize: vertical;
            min-height: 60px;
        }
        
        .signature-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #f9f9f9;
        }

        .signature-error {
            color: var(--error-color);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .signature-pad-container {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: white;
            height: 200px;
            margin: 10px 0;
            position: relative;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-pad-container.error {
            border-color: var(--error-color);
            box-shadow: 0 0 5px rgba(244, 67, 54, 0.5);
        }
        
        .signature-display {
            display: none;
            height: 80px;
            border-bottom: 1px solid #000;
            margin-top: 10px;
        }
        
        .signature-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .signature-controls button {
            padding: 8px 15px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .signature-controls button:hover {
            background: #00257a;
        }
        
        .signature-controls button.secondary {
            background: #6c757d;
        }
        
        .signature-controls button.secondary:hover {
            background: #5a6268;
        }
        
        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .logo {
            max-height: 60px;
        }
        
        .form-title {
            text-align: center;
            flex-grow: 1;
        }
        
        .signature-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .photo-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #f9f9f9;
        }
        
        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: none;
        }
        
        .fleet-manager-line {
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid #000;
        }
        
        /* Footer Navigation */
        .footer-nav {
            background: var(--primary-color);
            padding: 15px 0;
            margin-top: 30px;
        }
        
        .footer-nav ul {
            display: flex;
            justify-content: center;
            list-style: none;
            gap: 30px;
        }
        
        .footer-nav a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        .footer-nav a:hover {
            background: rgba(255,255,255,0.2);
        }
        
        /* Dashboard Styles */
        .dashboard-container {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 8px;
            max-width: 1000px;
            margin: 20px auto;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .summary-card {
            padding: 15px;
            border-radius: 8px;
            background: #f9f9f9;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .summary-card h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .issues-list {
            margin-top: 20px;
        }
        
        .issue-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .issue-item:last-child {
            border-bottom: none;
        }

        /* Regional Dashboard */
        .regional-dashboard {
            margin-top: 20px;
        }

        .region-card {
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .region-header {
            background: var(--primary-color);
            color: white;
            padding: 10px 15px;
            font-weight: bold;
        }

        .rsm-section {
            background: #e9ecef;
            padding: 8px 15px;
            font-weight: bold;
        }

        .tsm-list {
            padding: 10px 15px;
            background: white;
        }

        .tsm-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .tsm-item:last-child {
            border-bottom: none;
        }

        .vehicle-count {
            background: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: none;
        }

        .notification.success {
            background-color: var(--ok-color);
        }

        .notification.error {
            background-color: var(--error-color);
        }

        .notification.warning {
            background-color: var(--attention-color);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Notification Area -->
    <div class="notification" id="notification"></div>

    <!-- Header Banner -->
    <div class="header-banner">
        <div class="logo-container">
            <img src="https://via.placeholder.com/200x70/0033a0/FFFFFF?text=DSTV+TANZANIA" alt="DSTV Tanzania Logo" class="company-logo">
        </div>
        <div class="page-title">VEHICLE INSPECTION SYSTEM</div>
    </div>

    <!-- User Info -->
    <div class="user-info hidden" id="user-info">
        <span id="user-display">User</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- Login Container -->
    <div class="login-container" id="login-container">
        <h2>Login to Vehicle Inspection System</h2>
        <form class="login-form" id="login-form">
            <div class="form-group">
                <label for="user-role">Select Your Role</label>
                <select id="user-role" required>
                    <option value="">Select Role</option>
                    <option value="RSM">Regional Sales Manager (RSM)</option>
                    <option value="TSM">Territory Sales Manager (TSM)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="user-region">Select Your Region</label>
                <select id="user-region" required>
                    <option value="">Select Region</option>
                    <option value="DARES SALAAM">DARES SALAAM</option>
                    <option value="LAKE">LAKE</option>
                    <option value="SOUTHERN">SOUTHERN</option>
                    <option value="NORTHERN">NORTHERN</option>
                </select>
            </div>
            <div class="form-group">
                <label for="user-name">Your Name</label>
                <input type="text" id="user-name" placeholder="Enter your full name" required>
            </div>
            <button type="submit" class="login-btn">Login</button>
        </form>
    </div>

    <!-- Main Application (Hidden until login) -->
    <div id="app-container" class="hidden">
        <div class="form-container">
            <!-- Regional Selection -->
            <div class="regional-selection">
                <h3>Regional Assignment</h3>
                <div class="selection-row">
                    <div class="selection-group">
                        <label for="region-select">Region</label>
                        <select id="region-select">
                            <option value="">Select Region</option>
                        </select>
                    </div>
                    <div class="selection-group">
                        <label for="rsm-select">RSM</label>
                        <select id="rsm-select" disabled>
                            <option value="">Select RSM</option>
                        </select>
                    </div>
                </div>
                <div class="selection-row">
                    <div class="selection-group">
                        <label for="territory-select">Territory</label>
                        <select id="territory-select" disabled>
                            <option value="">Select Territory</option>
                        </select>
                    </div>
                    <div class="selection-group">
                        <label for="tsm-select">TSM</label>
                        <select id="tsm-select" disabled>
                            <option value="">Select TSM</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar">0%</div>
            </div>
            <div class="progress-text" id="progress-text">Form completion: 0% (0 of 0 fields filled)</div>

            <!-- Insights Panel -->
            <div class="insights-panel">
                <div class="insight-item insight-ok">
                    <div class="insight-count" id="ok-count">0</div>
                    <div class="insight-label">OK Items</div>
                </div>
                <div class="insight-item insight-attention">
                    <div class="insight-count" id="attention-count">0</div>
                    <div class="insight-label">Needs Attention</div>
                </div>
                <div class="insight-item insight-damage">
                    <div class="insight-count" id="damage-count">0</div>
                    <div class="insight-label">Damage Found</div>
                </div>
            </div>

            <table>
                <tr>
                    <th>Driver Name:</th>
                    <td><input type="text" id="driver-name" required></td>
                </tr>
                <tr>
                    <th>Vehicle Registration Number:</th>
                    <td><input type="text" id="vehicle-registration" required></td>
                </tr>
                <tr>
                    <th>Mileage (KM):</th>
                    <td><input type="text" id="mileage" required></td>
                </tr>
                <tr>
                    <th>Inspection Date:</th>
                    <td><input type="date" id="inspection-date" required></td>
                </tr>
            </table>

            <!-- Photo Section -->
            <div class="section-title">Vehicle Photos</div>
            <div class="photo-section">
                <p>Upload photos of any issues found during inspection:</p>
                <input type="file" id="photo-upload" accept="image/*" multiple>
                <div id="photo-preview-container"></div>
            </div>

            <!-- INTERIOR -->
            <div class="section-title">Interior Inspection</div>

            <table>
                <tr>
                    <th>Item</th>
                    <th width="180">Status</th>
                    <th>Comments</th>
                </tr>

                <tr>
                    <td>Seats and Interior</td>
                    <td>
                        <select class="status-select interior-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Needs Attention">Needs Attention</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Interior Lights</td>
                    <td>
                        <select class="status-select interior-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Needs Attention">Needs Attention</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Personal Valuables</td>
                    <td>
                        <select class="status-select interior-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Needs Attention">Needs Attention</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Warning Lights (e.g., MIL)</td>
                    <td>
                        <select class="status-select interior-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Needs Attention">Needs Attention</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Fuel Gauge</td>
                    <td>
                        <select class="status-select interior-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Needs Attention">Needs Attention</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Horn</td>
                    <td>
                        <select class="status-select interior-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Needs Attention">Needs Attention</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Wipers</td>
                    <td>
                        <select class="status-select interior-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Needs Attention">Needs Attention</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Power Windows</td>
                    <td>
                        <select class="status-select interior-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Needs Attention">Needs Attention</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Sunroof</td>
                    <td>
                        <select class="status-select interior-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Needs Attention">Needs Attention</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Door Mirrors</td>
                    <td>
                        <select class="status-select interior-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Needs Attention">Needs Attention</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Clutch (Check for smooth pedal feel)</td>
                    <td>
                        <select class="status-select interior-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Needs Attention">Needs Attention</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
            </table>

            <!-- EXTERIOR -->
            <div class="section-title">Exterior Inspection</div>

            <table>
                <tr>
                    <th>Item</th>
                    <th width="80">OK</th>
                    <th width="180">Scratched / Glass Damage / Worn Out</th>
                    <th>Comments</th>
                </tr>

                <tr>
                    <td>Windshield</td>
                    <td><input type="checkbox" class="ok-checkbox exterior-item"></td>
                    <td><input type="checkbox" class="damage-checkbox exterior-item"></td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Doors and Fenders</td>
                    <td><input type="checkbox" class="ok-checkbox exterior-item"></td>
                    <td><input type="checkbox" class="damage-checkbox exterior-item"></td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Rear Window</td>
                    <td><input type="checkbox" class="ok-checkbox exterior-item"></td>
                    <td><input type="checkbox" class="damage-checkbox exterior-item"></td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Trunk Lid and Bumper</td>
                    <td><input type="checkbox" class="ok-checkbox exterior-item"></td>
                    <td><input type="checkbox" class="damage-checkbox exterior-item"></td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Hood and Front Bumper</td>
                    <td><input type="checkbox" class="ok-checkbox exterior-item"></td>
                    <td><input type="checkbox" class="damage-checkbox exterior-item"></td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Tires and Wheels (All)</td>
                    <td><input type="checkbox" class="ok-checkbox exterior-item"></td>
                    <td><input type="checkbox" class="damage-checkbox exterior-item"></td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Canvas</td>
                    <td><input type="checkbox" class="ok-checkbox exterior-item"></td>
                    <td><input type="checkbox" class="damage-checkbox exterior-item"></td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Brand Condition</td>
                    <td><input type="checkbox" class="ok-checkbox exterior-item"></td>
                    <td><input type="checkbox" class="damage-checkbox exterior-item"></td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
            </table>

            <!-- FLUIDS -->
            <div class="section-title">Fluids and Battery</div>

            <table>
                <tr>
                    <th>Fluid Type</th>
                    <th width="180">Status</th>
                    <th>Comments</th>
                </tr>

                <tr>
                    <td>Engine Oil</td>
                    <td>
                        <select class="fluid-status fluid-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Low">Low</option>
                            <option value="Replace">Replace</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Brake Fluid</td>
                    <td>
                        <select class="fluid-status fluid-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Low">Low</option>
                            <option value="Replace">Replace</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Coolant</td>
                    <td>
                        <select class="fluid-status fluid-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Low">Low</option>
                            <option value="Replace">Replace</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Power Steering Fluid</td>
                    <td>
                        <select class="fluid-status fluid-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Low">Low</option>
                            <option value="Replace">Replace</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Clutch Fluid</td>
                    <td>
                        <select class="fluid-status fluid-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Low">Low</option>
                            <option value="Replace">Replace</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Windshield Washer Fluid</td>
                    <td>
                        <select class="fluid-status fluid-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Low">Low</option>
                            <option value="Replace">Replace</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
                <tr>
                    <td>Battery Condition</td>
                    <td>
                        <select class="fluid-status fluid-item" required>
                            <option value="">Select Status</option>
                            <option value="OK">OK</option>
                            <option value="Low">Low</option>
                            <option value="Replace">Replace</option>
                        </select>
                    </td>
                    <td><textarea placeholder="Enter comments..."></textarea></td>
                </tr>
            </table>

            <!-- Signatures -->
            <div class="section-title" style="margin-top: 40px;">Signatures</div>
            
            <div class="signature-section">
                <h3>Driver Signature <span style="color: var(--error-color);">*</span></h3>
                <p>Please sign in the box below using your mouse or touchscreen:</p>
                
                <div class="signature-pad-container" id="driver-signature-pad">
                    <canvas id="driver-signature-canvas"></canvas>
                </div>
                <div class="signature-error" id="signature-error">Signature is required to submit the form</div>
                
                <div class="signature-controls">
                    <button id="clear-driver-signature">Clear Signature</button>
                    <button id="save-driver-signature" class="secondary">Save Signature</button>
                </div>
                
                <div class="signature-display" id="driver-signature-display">
                    <!-- Saved signature will appear here when printing -->
                </div>
                <div class="signature-label">Driver Signature</div>
            </div>
            
            <div class="fleet-manager-line">
                <p><strong>Fleet Manager Signature:</strong> _________________________________________</p>
                <p><em>(To be signed manually after review)</em></p>
            </div>
        </div>

        <div class="action-buttons">
            <button class="action-btn" onclick="window.print()">Print / Save PDF</button>
            <button class="action-btn secondary" id="save-inspection-btn" onclick="validateAndSaveForm()">Save Inspection</button>
            <button class="action-btn secondary" onclick="clearForm()">Clear Form</button>
        </div>

        <!-- Footer Navigation -->
        <div class="footer-nav">
            <ul>
                <li><a href="#" onclick="showWeeklyForm()">Weekly Inspection</a></li>
                <li><a href="#" onclick="showMonthlyDashboard()">Monthly Dashboard</a></li>
                <li><a href="#" onclick="showRegionalDashboard()">Regional Dashboard</a></li>
            </ul>
        </div>

        <!-- Monthly Dashboard -->
        <div class="dashboard-container" id="monthly-dashboard">
            <h2>Monthly Inspection Dashboard</h2>
            <p>Summary of all weekly inspections for the current month</p>
            
            <div class="summary-cards" id="summary-cards">
                <!-- Summary cards will be dynamically generated -->
            </div>
            
            <div class="issues-list" id="issues-list">
                <h3>Recent Issues Requiring Attention</h3>
                <!-- Issues will be dynamically generated -->
            </div>
        </div>

        <!-- Regional Dashboard -->
        <div class="dashboard-container" id="regional-dashboard">
            <h2>Regional Vehicle Dashboard</h2>
            <p>Overview of vehicles by region, RSM, and TSM</p>
            
            <div class="regional-dashboard" id="regional-dashboard-content">
                <!-- Regional dashboard content will be dynamically generated -->
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://your-project-url.supabase.co'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'your-anon-key'; // Replace with your Supabase anon key
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Current user session
        let currentUser = null;
        
        // Regional data structure based on the provided information
        const regionalData = {
            "DARES SALAAM": {
                rsm: "HLBET ISOWE",
                territories: {
                    "ILA": { tsm: "LOMAYANI LAIRUMBE", vehicles: [] },
                    "ZNZ": { tsm: "", vehicles: [] },
                    "KIN": { tsm: "EVARINE JOSEPH", vehicles: [] },
                    "TMK": { tsm: "KHALEED KOROSHENI", vehicles: [] },
                    "MTR/UND": { tsm: "", vehicles: [] },
                    "MRG": { tsm: "EMANUEL MELITA", vehicles: [] }
                }
            },
            "LAKE": {
                rsm: "ISAC ATTER",
                territories: {
                    "MWZ": { tsm: "INNOCENT KEMBO", vehicles: [] },
                    "MARA/SMY": { tsm: "", vehicles: [] },
                    "GET/KGR/SHY": { tsm: "ABDALLAH CHAMA", vehicles: [] },
                    "TBR/KGM": { tsm: "BRIAN GROSSO", vehicles: [] }
                }
            },
            "SOUTHERN": {
                rsm: "WACHACHE MWENDA",
                territories: {
                    "MBY/SGW": { tsm: "MODESTUS GANIA", vehicles: [] },
                    "KTV/RKW": { tsm: "", vehicles: [] },
                    "IR/NJB/RVM": { tsm: "DAVID MBAZA", vehicles: [] }
                }
            },
            "NORTHERN": {
                rsm: "STEVENMWANGAMILA",
                territories: {
                    "AR/MNY": { tsm: "JOSEPH JOHN", vehicles: [] },
                    "KIL/TNG": { tsm: "Innocent Ulami", vehicles: [] },
                    "DOM/SING": { tsm: "ANOVA MKALENDA", vehicles: [] }
                }
            }
        };

        // Set today's date as default
        document.getElementById('inspection-date').valueAsDate = new Date();
        
        // Login functionality
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const role = document.getElementById('user-role').value;
            const region = document.getElementById('user-region').value;
            const name = document.getElementById('user-name').value;
            
            if (!role || !region || !name) {
                showNotification('Please fill all fields', 'error');
                return;
            }
            
            // Set current user
            currentUser = {
                role: role,
                region: region,
                name: name,
                loginTime: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Update UI
            document.getElementById('user-display').textContent = `${name} (${role} - ${region})`;
            document.getElementById('user-info').classList.remove('hidden');
            document.getElementById('login-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // Initialize regional selection based on user role and region
            initializeRegionalSelection();
            
            showNotification(`Welcome ${name}!`, 'success');
        });
        
        // Logout functionality
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('login-container').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
            
            showNotification('Logged out successfully', 'success');
        }
        
        // Check if user is already logged in
        function checkExistingLogin() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('user-display').textContent = `${currentUser.name} (${currentUser.role} - ${currentUser.region})`;
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                initializeRegionalSelection();
            }
        }
        
        // Initialize regional selection based on user role
        function initializeRegionalSelection() {
            const regionSelect = document.getElementById('region-select');
            const rsmSelect = document.getElementById('rsm-select');
            const territorySelect = document.getElementById('territory-select');
            const tsmSelect = document.getElementById('tsm-select');
            
            // Clear all selects
            regionSelect.innerHTML = '<option value="">Select Region</option>';
            rsmSelect.innerHTML = '<option value="">Select RSM</option>';
            territorySelect.innerHTML = '<option value="">Select Territory</option>';
            tsmSelect.innerHTML = '<option value="">Select TSM</option>';
            
            // Set region based on user's region
            if (currentUser.role === 'RSM') {
                // RSM can only select their own region
                const option = document.createElement('option');
                option.value = currentUser.region;
                option.textContent = currentUser.region;
                option.selected = true;
                regionSelect.appendChild(option);
                regionSelect.disabled = true;
                
                // Populate RSM
                rsmSelect.disabled = false;
                const rsmOption = document.createElement('option');
                rsmOption.value = currentUser.name;
                rsmOption.textContent = currentUser.name;
                rsmOption.selected = true;
                rsmSelect.appendChild(rsmOption);
                rsmSelect.disabled = true;
                
                // Populate territories
                territorySelect.disabled = false;
                for (const territory in regionalData[currentUser.region].territories) {
                    const option = document.createElement('option');
                    option.value = territory;
                    option.textContent = territory;
                    territorySelect.appendChild(option);
                }
            } else if (currentUser.role === 'TSM') {
                // TSM can only select their own region and territory
                const option = document.createElement('option');
                option.value = currentUser.region;
                option.textContent = currentUser.region;
                option.selected = true;
                regionSelect.appendChild(option);
                regionSelect.disabled = true;
                
                // Populate RSM
                rsmSelect.disabled = false;
                const rsmOption = document.createElement('option');
                rsmOption.value = regionalData[currentUser.region].rsm;
                rsmOption.textContent = regionalData[currentUser.region].rsm;
                rsmOption.selected = true;
                rsmSelect.appendChild(rsmOption);
                rsmSelect.disabled = true;
                
                // Find which territory this TSM belongs to
                let userTerritory = null;
                for (const territory in regionalData[currentUser.region].territories) {
                    if (regionalData[currentUser.region].territories[territory].tsm === currentUser.name) {
                        userTerritory = territory;
                        break;
                    }
                }
                
                // Populate territory
                territorySelect.disabled = false;
                if (userTerritory) {
                    const option = document.createElement('option');
                    option.value = userTerritory;
                    option.textContent = userTerritory;
                    option.selected = true;
                    territorySelect.appendChild(option);
                    territorySelect.disabled = true;
                    
                    // Populate TSM
                    tsmSelect.disabled = false;
                    const tsmOption = document.createElement('option');
                    tsmOption.value = currentUser.name;
                    tsmOption.textContent = currentUser.name;
                    tsmOption.selected = true;
                    tsmSelect.appendChild(tsmOption);
                    tsmSelect.disabled = true;
                }
            }
            
            // Territory change event
            territorySelect.addEventListener('change', function() {
                const selectedRegion = regionSelect.value;
                const selectedTerritory = this.value;
                
                // Clear TSM select
                tsmSelect.innerHTML = '<option value="">Select TSM</option>';
                
                if (selectedRegion && selectedTerritory) {
                    // Enable TSM select and populate
                    tsmSelect.disabled = false;
                    const tsm = regionalData[selectedRegion].territories[selectedTerritory].tsm;
                    if (tsm) {
                        const option = document.createElement('option');
                        option.value = tsm;
                        option.textContent = tsm;
                        tsmSelect.appendChild(option);
                    }
                } else {
                    tsmSelect.disabled = true;
                }
            });
        }
        
        // Track form fields for progress calculation
        const allFields = [
            'driver-name', 'vehicle-registration', 'mileage', 'inspection-date'
        ];
        
        // Add all select fields and textareas to tracking
        document.querySelectorAll('.status-select, .fluid-status, textarea').forEach(field => {
            allFields.push(field);
        });
        
        // Add checkboxes to tracking
        document.querySelectorAll('.ok-checkbox, .damage-checkbox').forEach(field => {
            allFields.push(field);
        });
        
        // Signature functionality
        function initializeSignaturePad(canvasId, displayId) {
            const canvas = document.getElementById(canvasId);
            const display = document.getElementById(displayId);
            const ctx = canvas.getContext('2d');
            
            // Set canvas dimensions
            const container = canvas.parentElement;
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;
            
            // Set canvas styling
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;
            let signatureData = null;
            let hasDrawn = false;
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile devices
            canvas.addEventListener('touchstart', handleTouchStart);
            canvas.addEventListener('touchmove', handleTouchMove);
            canvas.addEventListener('touchend', stopDrawing);
            
            function handleTouchStart(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
            
            function handleTouchMove(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            }
            
            function startDrawing(e) {
                isDrawing = true;
                [lastX, lastY] = [e.offsetX, e.offsetY];
                hasDrawn = true;
                hideSignatureError();
            }
            
            function draw(e) {
                if (!isDrawing) return;
                
                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(e.offsetX, e.offsetY);
                ctx.stroke();
                
                [lastX, lastY] = [e.offsetX, e.offsetY];
            }
            
            function stopDrawing() {
                isDrawing = false;
                // Save the signature data
                if (hasDrawn) {
                    signatureData = canvas.toDataURL();
                    updateProgress(); // Update progress when signature is drawn
                }
            }
            
            function clearSignature() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                signatureData = null;
                hasDrawn = false;
                display.style.backgroundImage = '';
                updateProgress();
                hideSignatureError();
            }
            
            function saveSignature() {
                if (signatureData) {
                    // Create an image element for the display
                    display.style.backgroundImage = `url(${signatureData})`;
                    display.style.backgroundSize = 'contain';
                    display.style.backgroundRepeat = 'no-repeat';
                    display.style.backgroundPosition = 'center';
                    
                    // Save to localStorage
                    const signatureKey = 'driverSignature';
                    localStorage.setItem(signatureKey, signatureData);
                    
                    showNotification('Signature saved successfully!', 'success');
                    updateProgress();
                    hideSignatureError();
                } else {
                    showSignatureError();
                    showNotification('Please provide a signature first.', 'error');
                }
            }
            
            function hasValidSignature() {
                return signatureData !== null && hasDrawn;
            }
            
            function showSignatureError() {
                document.getElementById('signature-error').style.display = 'block';
                document.getElementById('driver-signature-pad').classList.add('error');
            }
            
            function hideSignatureError() {
                document.getElementById('signature-error').style.display = 'none';
                document.getElementById('driver-signature-pad').classList.remove('error');
            }
            
            return {
                clearSignature,
                saveSignature,
                hasValidSignature,
                showSignatureError,
                hideSignatureError
            };
        }
        
        // Initialize signature pads
        const driverSignature = initializeSignaturePad('driver-signature-canvas', 'driver-signature-display');
        
        // Add event listeners for signature buttons
        document.getElementById('clear-driver-signature').addEventListener('click', driverSignature.clearSignature);
        document.getElementById('save-driver-signature').addEventListener('click', driverSignature.saveSignature);
        
        // Photo upload functionality
        document.getElementById('photo-upload').addEventListener('change', function(e) {
            const files = e.target.files;
            const previewContainer = document.getElementById('photo-preview-container');
            previewContainer.innerHTML = '';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'photo-preview';
                    img.style.display = 'block';
                    previewContainer.appendChild(img);
                }
                
                reader.readAsDataURL(file);
            }
            
            updateProgress();
        });
        
        // Update progress bar and insights
        function updateProgress() {
            let filledCount = 0;
            let totalFields = allFields.length;
            
            // Count filled fields
            allFields.forEach(field => {
                if (typeof field === 'string') {
                    // It's an ID
                    const element = document.getElementById(field);
                    if (element && element.value.trim() !== '') {
                        filledCount++;
                    }
                } else {
                    // It's a DOM element
                    if (field.type === 'checkbox') {
                        if (field.checked) filledCount++;
                    } else if (field.value && field.value.trim() !== '') {
                        filledCount++;
                    }
                }
            });
            
            // Check if signature is provided
            if (driverSignature.hasValidSignature()) {
                filledCount++;
                totalFields++; // Add signature as a field
            }
            
            // Check if photos are uploaded
            const photoUpload = document.getElementById('photo-upload');
            if (photoUpload.files.length > 0) {
                filledCount++;
                totalFields++; // Add photos as a field
            }
            
            // Calculate percentage
            const percentage = totalFields > 0 ? Math.round((filledCount / totalFields) * 100) : 0;
            
            // Update progress bar
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}%`;
            
            // Update progress text
            document.getElementById('progress-text').textContent = 
                `Form completion: ${percentage}% (${filledCount} of ${totalFields} fields filled)`;
            
            // Update insights
            updateInsights();
        }
        
        // Update insights panel
        function updateInsights() {
            let okCount = 0;
            let attentionCount = 0;
            let damageCount = 0;
            
            // Count OK statuses
            document.querySelectorAll('.status-select').forEach(select => {
                if (select.value === 'OK') okCount++;
                if (select.value === 'Needs Attention') attentionCount++;
            });
            
            // Count fluid statuses
            document.querySelectorAll('.fluid-status').forEach(select => {
                if (select.value === 'OK') okCount++;
                if (select.value === 'Low' || select.value === 'Replace') attentionCount++;
            });
            
            // Count exterior checkboxes
            document.querySelectorAll('.ok-checkbox').forEach(checkbox => {
                if (checkbox.checked) okCount++;
            });
            
            document.querySelectorAll('.damage-checkbox').forEach(checkbox => {
                if (checkbox.checked) damageCount++;
            });
            
            // Update insight counts
            document.getElementById('ok-count').textContent = okCount;
            document.getElementById('attention-count').textContent = attentionCount;
            document.getElementById('damage-count').textContent = damageCount;
        }
        
        // Add event listeners to all form fields to update progress
        document.querySelectorAll('input, select, textarea').forEach(field => {
            field.addEventListener('input', updateProgress);
            field.addEventListener('change', updateProgress);
        });
        
        // Show notification
        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
        
        // Validate and save form
        function validateAndSaveForm() {
            // Check if signature is provided
            if (!driverSignature.hasValidSignature()) {
                driverSignature.showSignatureError();
                showNotification('Please provide your signature before saving.', 'error');
                return;
            }
            
            // Check if regional assignment is complete
            const region = document.getElementById('region-select').value;
            const territory = document.getElementById('territory-select').value;
            
            if (!region || !territory) {
                showNotification('Please complete the regional assignment before saving.', 'error');
                return;
            }
            
            // Save form data to Supabase
            saveFormDataToSupabase();
        }
        
        // Function to save form data to Supabase
        async function saveFormDataToSupabase() {
            const region = document.getElementById('region-select').value;
            const rsm = document.getElementById('rsm-select').value;
            const territory = document.getElementById('territory-select').value;
            const tsm = document.getElementById('tsm-select').value;
            
            const formData = {
                driver_name: document.getElementById('driver-name').value,
                vehicle_registration: document.getElementById('vehicle-registration').value,
                mileage: document.getElementById('mileage').value,
                inspection_date: document.getElementById('inspection-date').value,
                region: region,
                rsm: rsm,
                territory: territory,
                tsm: tsm,
                submitted_by: currentUser.name,
                submitted_by_role: currentUser.role,
                submitted_at: new Date().toISOString(),
                signature_data: localStorage.getItem('driverSignature')
            };
            
            // Collect all inspection data
            const inspectionData = {
                interior: [],
                exterior: [],
                fluids: []
            };
            
            // Interior items
            document.querySelectorAll('.interior-item').forEach((select, index) => {
                const row = select.closest('tr');
                const itemName = row.cells[0].textContent;
                const comments = row.cells[2].querySelector('textarea').value;
                
                inspectionData.interior.push({
                    item: itemName,
                    status: select.value,
                    comments: comments
                });
            });
            
            // Exterior items
            document.querySelectorAll('.exterior-item').forEach((checkbox, index) => {
                if (index % 2 === 0) { // Only process OK checkboxes (every other one)
                    const row = checkbox.closest('tr');
                    const itemName = row.cells[0].textContent;
                    const okChecked = row.cells[1].querySelector('.ok-checkbox').checked;
                    const damageChecked = row.cells[2].querySelector('.damage-checkbox').checked;
                    const comments = row.cells[3].querySelector('textarea').value;
                    
                    inspectionData.exterior.push({
                        item: itemName,
                        ok: okChecked,
                        damage: damageChecked,
                        comments: comments
                    });
                }
            });
            
            // Fluid items
            document.querySelectorAll('.fluid-item').forEach((select, index) => {
                const row = select.closest('tr');
                const itemName = row.cells[0].textContent;
                const comments = row.cells[2].querySelector('textarea').value;
                
                inspectionData.fluids.push({
                    item: itemName,
                    status: select.value,
                    comments: comments
                });
            });
            
            // Combine all data
            const completeData = {
                ...formData,
                interior_inspection: inspectionData.interior,
                exterior_inspection: inspectionData.exterior,
                fluids_inspection: inspectionData.fluids
            };
            
            try {
                // Insert data into Supabase
                const { data, error } = await supabase
                    .from('vehicle_inspections')
                    .insert([completeData]);
                
                if (error) {
                    throw error;
                }
                
                showNotification('Inspection saved successfully to database!', 'success');
                
                // Clear form after successful save
                setTimeout(() => {
                    clearForm();
                }, 2000);
                
            } catch (error) {
                console.error('Error saving to Supabase:', error);
                showNotification('Error saving inspection to database. Please try again.', 'error');
            }
        }
        
        // Function to load inspections from Supabase
        async function loadInspectionsFromSupabase() {
            try {
                let query = supabase
                    .from('vehicle_inspections')
                    .select('*');
                
                // If user is TSM, only load their inspections
                if (currentUser.role === 'TSM') {
                    query = query.eq('tsm', currentUser.name);
                }
                // If user is RSM, only load inspections from their region
                else if (currentUser.role === 'RSM') {
                    query = query.eq('region', currentUser.region);
                }
                
                const { data, error } = await query;
                
                if (error) {
                    throw error;
                }
                
                return data || [];
            } catch (error) {
                console.error('Error loading from Supabase:', error);
                showNotification('Error loading inspections from database.', 'error');
                return [];
            }
        }
        
        // Function to clear the form
        function clearForm() {
            if (confirm('Are you sure you want to clear all form data?')) {
                document.querySelectorAll('input, select, textarea').forEach(element => {
                    if (element.type !== 'button' && element.id !== 'photo-upload') {
                        element.value = '';
                    }
                });
                
                document.querySelectorAll('.ok-checkbox, .damage-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Reset date to today
                document.getElementById('inspection-date').valueAsDate = new Date();
                
                // Clear signature
                driverSignature.clearSignature();
                
                // Clear signature display
                document.getElementById('driver-signature-display').style.backgroundImage = '';
                
                // Clear photo preview
                document.getElementById('photo-preview-container').innerHTML = '';
                document.getElementById('photo-upload').value = '';
                
                // Clear from localStorage
                localStorage.removeItem('driverSignature');
                
                updateProgress();
                
                showNotification('Form cleared successfully!', 'success');
            }
        }
        
        // Add visual feedback for status selections
        document.querySelectorAll('.status-select, .fluid-status').forEach(select => {
            select.addEventListener('change', function() {
                this.classList.remove('status-ok', 'status-attention', 'status-replace');
                
                if (this.value === 'OK') {
                    this.classList.add('status-ok');
                } else if (this.value === 'Needs Attention' || this.value === 'Low') {
                    this.classList.add('status-attention');
                } else if (this.value === 'Replace') {
                    this.classList.add('status-replace');
                }
            });
        });
        
        // Navigation functions
        function showWeeklyForm() {
            document.getElementById('monthly-dashboard').style.display = 'none';
            document.getElementById('regional-dashboard').style.display = 'none';
            document.querySelector('.form-container').style.display = 'block';
        }
        
        async function showMonthlyDashboard() {
            document.querySelector('.form-container').style.display = 'none';
            document.getElementById('regional-dashboard').style.display = 'none';
            const dashboard = document.getElementById('monthly-dashboard');
            dashboard.style.display = 'block';
            
            // Generate dashboard content from Supabase data
            await generateDashboardFromSupabase();
        }
        
        async function showRegionalDashboard() {
            document.querySelector('.form-container').style.display = 'none';
            document.getElementById('monthly-dashboard').style.display = 'none';
            const dashboard = document.getElementById('regional-dashboard');
            dashboard.style.display = 'block';
            
            // Generate regional dashboard content from Supabase data
            await generateRegionalDashboardFromSupabase();
        }
        
        // Generate monthly dashboard from Supabase data
        async function generateDashboardFromSupabase() {
            const inspections = await loadInspectionsFromSupabase();
            const summaryCards = document.getElementById('summary-cards');
            const issuesList = document.getElementById('issues-list');
            
            // Clear previous content
            summaryCards.innerHTML = '';
            issuesList.innerHTML = '<h3>Recent Issues Requiring Attention</h3>';
            
            if (inspections.length === 0) {
                summaryCards.innerHTML = '<p>No inspection data available.</p>';
                issuesList.innerHTML += '<p>No issues reported.</p>';
                return;
            }
            
            // Calculate summary statistics
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            const monthlyInspections = inspections.filter(inspection => {
                const inspectionDate = new Date(inspection.inspection_date);
                return inspectionDate.getMonth() === currentMonth && 
                       inspectionDate.getFullYear() === currentYear;
            });
            
            // Count vehicles inspected this month
            const vehicleCount = [...new Set(monthlyInspections.map(i => i.vehicle_registration))].length;
            
            // Count issues
            let issueCount = 0;
            let attentionCount = 0;
            
            monthlyInspections.forEach(inspection => {
                // Count interior issues
                inspection.interior_inspection.forEach(item => {
                    if (item.status === 'Needs Attention') {
                        attentionCount++;
                    }
                });
                
                // Count exterior damage
                inspection.exterior_inspection.forEach(item => {
                    if (item.damage) {
                        issueCount++;
                    }
                });
                
                // Count fluid issues
                inspection.fluids_inspection.forEach(item => {
                    if (item.status === 'Low' || item.status === 'Replace') {
                        attentionCount++;
                    }
                });
            });
            
            // Create summary cards
            const cards = [
                { title: 'Weekly Inspections', value: monthlyInspections.length, color: '#0033a0' },
                { title: 'Vehicles Inspected', value: vehicleCount, color: '#4CAF50' },
                { title: 'Damage Reports', value: issueCount, color: '#F44336' },
                { title: 'Attention Needed', value: attentionCount, color: '#FF9800' }
            ];
            
            cards.forEach(card => {
                const cardElement = document.createElement('div');
                cardElement.className = 'summary-card';
                cardElement.innerHTML = `
                    <h3>${card.title}</h3>
                    <div class="insight-count" style="color: ${card.color}">${card.value}</div>
                `;
                summaryCards.appendChild(cardElement);
            });
            
            // Create issues list
            const issuesContainer = document.createElement('div');
            
            monthlyInspections.forEach(inspection => {
                // Add interior issues
                inspection.interior_inspection.forEach(item => {
                    if (item.status === 'Needs Attention' && item.comments) {
                        const issueElement = document.createElement('div');
                        issueElement.className = 'issue-item';
                        issueElement.innerHTML = `
                            <strong>${inspection.vehicle_registration} - ${item.item}</strong><br>
                            ${item.comments} (${new Date(inspection.submitted_at).toLocaleDateString()})
                        `;
                        issuesContainer.appendChild(issueElement);
                    }
                });
                
                // Add exterior damage
                inspection.exterior_inspection.forEach(item => {
                    if (item.damage && item.comments) {
                        const issueElement = document.createElement('div');
                        issueElement.className = 'issue-item';
                        issueElement.innerHTML = `
                            <strong>${inspection.vehicle_registration} - ${item.item}</strong><br>
                            ${item.comments} (${new Date(inspection.submitted_at).toLocaleDateString()})
                        `;
                        issuesContainer.appendChild(issueElement);
                    }
                });
                
                // Add fluid issues
                inspection.fluids_inspection.forEach(item => {
                    if ((item.status === 'Low' || item.status === 'Replace') && item.comments) {
                        const issueElement = document.createElement('div');
                        issueElement.className = 'issue-item';
                        issueElement.innerHTML = `
                            <strong>${inspection.vehicle_registration} - ${item.item}</strong><br>
                            ${item.comments} (${new Date(inspection.submitted_at).toLocaleDateString()})
                        `;
                        issuesContainer.appendChild(issueElement);
                    }
                });
            });
            
            if (issuesContainer.children.length === 0) {
                issuesContainer.innerHTML = '<p>No issues requiring attention found in recent inspections.</p>';
            }
            
            issuesList.appendChild(issuesContainer);
        }
        
        // Generate regional dashboard from Supabase data
        async function generateRegionalDashboardFromSupabase() {
            const inspections = await loadInspectionsFromSupabase();
            const dashboardContent = document.getElementById('regional-dashboard-content');
            dashboardContent.innerHTML = '';
            
            // Group inspections by region
            const regions = {};
            
            inspections.forEach(inspection => {
                if (!regions[inspection.region]) {
                    regions[inspection.region] = {
                        rsm: inspection.rsm,
                        territories: {}
                    };
                }
                
                if (!regions[inspection.region].territories[inspection.territory]) {
                    regions[inspection.region].territories[inspection.territory] = {
                        tsm: inspection.tsm,
                        vehicles: []
                    };
                }
                
                // Add vehicle if not already added
                if (!regions[inspection.region].territories[inspection.territory].vehicles.includes(inspection.vehicle_registration)) {
                    regions[inspection.region].territories[inspection.territory].vehicles.push(inspection.vehicle_registration);
                }
            });
            
            // Create dashboard cards
            for (const region in regions) {
                const regionCard = document.createElement('div');
                regionCard.className = 'region-card';
                
                const regionHeader = document.createElement('div');
                regionHeader.className = 'region-header';
                regionHeader.textContent = region;
                
                const rsmSection = document.createElement('div');
                rsmSection.className = 'rsm-section';
                rsmSection.textContent = `RSM: ${regions[region].rsm}`;
                
                const tsmList = document.createElement('div');
                tsmList.className = 'tsm-list';
                
                for (const territory in regions[region].territories) {
                    const tsmItem = document.createElement('div');
                    tsmItem.className = 'tsm-item';
                    
                    const tsmInfo = document.createElement('div');
                    tsmInfo.innerHTML = `<strong>${territory}</strong> - ${regions[region].territories[territory].tsm || 'No TSM assigned'}`;
                    
                    const vehicleCount = document.createElement('div');
                    const vehicles = regions[region].territories[territory].vehicles || [];
                    vehicleCount.innerHTML = `<span class="vehicle-count">${vehicles.length} vehicles</span>`;
                    
                    tsmItem.appendChild(tsmInfo);
                    tsmItem.appendChild(vehicleCount);
                    tsmList.appendChild(tsmItem);
                }
                
                regionCard.appendChild(regionHeader);
                regionCard.appendChild(rsmSection);
                regionCard.appendChild(tsmList);
                dashboardContent.appendChild(regionCard);
            }
        }
        
        // Load saved data when page loads
        window.addEventListener('DOMContentLoaded', function() {
            checkExistingLogin();
            
            // Handle window resize
            window.addEventListener('resize', function() {
                // Reinitialize canvas dimensions on resize
                const driverCanvas = document.getElementById('driver-signature-canvas');
                const driverContainer = driverCanvas.parentElement;
                
                driverCanvas.width = driverContainer.offsetWidth;
                driverCanvas.height = driverContainer.offsetHeight;
            });
        });
    </script>
</body>
</html>
